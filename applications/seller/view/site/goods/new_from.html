
<script src="<{$base_url}>/public/javascripts/summernote/summernote.min.js"></script>
<script src="<{$base_url}>/public/javascripts/summernote/lang/summernote-zh-CN.js"></script>
<{script app=desktop src="../com/global/plugins/jquery-tags-input/jquery.tagsinput.min.js" }>
<script src="<{$base_url}>/public/javascripts/summernote/summernot_set.js"></script>

<link rel="stylesheet" type="text/css" href="<{$base_url}>/public/stylesheets/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="<{$base_url}>/public/stylesheets/summernote.css">
<{css app=desktop href="../com/global/plugins/jquery-tags-input/jquery.tagsinput.css" }>

<div class="page-seller">
    <div class="page-header">
        <h1><{if $goods}>编辑商品<{else}>添加商品_new<{/if}></h1>
    </div>
    <form class="form-horizontal addgoods_form" action="<{link app=seller ctl=site_goods act=save}>" method="post" id="goods_edit_form" data-module="validator">
        <div class="goods_tabbox">
            <!-- 商品基本信息 -->
            <{include file="site/goods/new_detail/basic.html"}>
            <!-- 属性参数 -->
            <{include file="site/goods/new_detail/params.html"}>
            <!-- 商品规格 -->
            <{include file="site/goods/new_detail/spec.html"}>
            <!-- 图文介绍 -->
            <h4>图文介绍</h4>
            <div role="tabpanel" class="tab-pane" id="tuwen">
                <div class="editerbox">
                    <textarea id="summernote" name="goods[description]" value=""><{$goods.description}></textarea>
                    <{*input type=html name="goods[description]" remote=site*}>

                </div>
            </div>
            <{include file="site/goods/detail/content.html"}>
        </div>

        <div class="form_action">
            <a class="save_goods btn-default" href="<{link app=seller ctl=site_goods act=index}>">返回商品列表</a>
            <button class="save_goods btn-danger" data-redirect="<{link app=seller ctl=site_goods act=save}>&p[0]={goods_id}">保存</button>
        </div>
    </form>
</div>



<textarea class="spec-item-tpl hide">
 <tr>
     <td>
         <div class="input-group">
             <input class="form-control spec-t" name="goods[spec_desc][t][]" type="text" value="" placeholder="规格名称">
         </div>
     </td>
     <td>
         <input  class='form-control spec-v' name="goods[spec_desc][v][]" type="text"  value="">
     </td>
     <td>
         <button type=button class="btn btn-sm spec-del default"><i class="glyphicon glyphicon-trash"></i></button>
     </td>
 </tr>
</textarea>
<textarea class="product-item-tpl hide">
<tr>
    <td>
        <input type="text"  name="goods[product][{key}][spec_info]" class="form-control input-sm spec-info" value="{spec_info}" readonly=true>
        <input type="hidden" name="goods[product][{key}][spec_desc]" class="spec-desc"  value="{spec_desc}" >
    </td>
    <td>
        <input type="text" required="true" data-map="bn" class="form-control input-sm" name="goods[product][{key}][bn]" value="">
    </td>
    <td>
        <input type="text" data-map="barcode" class="form-control input-sm" name="goods[product][{key}][barcode]" value="">
    </td>
    <td>
        <input type="text" data-map="price" class="form-control input-sm" name="goods[product][{key}][price]" value="">
    </td>
    <td>
        <input type="text" data-map="mktprice" class="form-control input-sm" name="goods[product][{key}][mktprice]" value="">
    </td>
    <td>
        <input type="text" data-map="weight" name="goods[product][{key}][weight]" class="form-control input-sm input-xsmall" value="" placeholder="克">
    </td>
    <td>
        <input type="text" data-map="unit" name="goods[product][{key}][unit]" class="form-control input-sm input-xsmall" value="">
    </td>
    <td>
        <input type="checkbox"  name="goods[product][{key}][marketable]" value="true" checked>
    </td>
</tr>
</textarea>


<script>
    !function(){

            /**
             * 新增粘贴事件
             *
             *    $("input[type='text']").on("postpaste", function() {
             *        // code...
             *    }).pasteEvents();
             *
             *
             */
            /*$.fn.pasteEvents = function( delay ) {
                if (delay == undefined) delay = 20;
                return $(this).each(function() {
                    var $el = $(this);
                    $el.on("paste", function() {
                        $el.trigger("prepaste");
                        setTimeout(function() { $el.trigger("postpaste"); }, delay);
                    });
                });
            };*/


            $('#spec_edit_pane .checker :checkbox').on('change',function(){
                var checked = $(this).is(':checked');
                $('#spec_edit_pane .spec-edit,#spec_edit_pane .product-items')[checked?'removeClass':'addClass']('hide');
                $('#spec_edit_pane .spec-edit,#spec_edit_pane .product-items').find('input,:checkbox,:radio,textarea').attr('disabled',checked?false:true);
                $(this).parent('span')[checked?'addClass':'removeClass']('checked');
            });
            $('#spec_edit_pane .checker :checkbox').change();
            var substitute = function(str,obj){
                return str.replace(/\\?\{([^{}]+)\}/g, function(match, name){
                    if (match.charAt(0) == '\\') return match.slice(1);
                    return (obj[name] != undefined) ? obj[name] : '';
                });
            }

            var tagsinput_options = {
                width: 'auto',
                'defaultText':'新规格项',
                onAddTag:function(){
                    product_items_change();
                },
                onRemoveTag:function(){
                    product_items_change();
                }
            };
            $('#spec_edit_pane .spec-edit .spec-v').tagsInput(tagsinput_options);
            $('#spec_edit_pane .spec-edit .new-spec-item').on('click',function(){
                $('#spec_edit_pane .spec-edit tbody').append($('.spec-item-tpl').val());
                $('#spec_edit_pane .spec-edit tbody tr:last .spec-v').tagsInput(tagsinput_options);
            });
            $('#spec_edit_pane .spec-edit').on('click','.spec-del',function(e){
                e.stopPropagation();
                if(!confirm('确定删除？'))return;
                $(this).closest('tr').remove();
                product_items_change();
            });
            /**
             * 货号、条码 粘贴监听
             * @see desktop.js
             */
            var listen_postpaste = function(els){

                //只监听第一个
                $(els).eq(0).on("postpaste", function(e) {
                    var val = $(this).val(),val_arr = val.split(/\s/);;
                    if(val_arr.length && val_arr.length>1){
                        $.each(val_arr,function(i,v){
                            $(els).eq(i).val(v);
                        });
                    }
                }).pasteEvents();

                //便捷性提示
                $(els).eq(0).wrap('<div class="input-icon right"></div>');
                $('<i class="fa fa-paste text-success tooltips" data-container="body" data-toggle="tooltip" data-placement="top" title="粘贴含有`空格`或`换行`的数据,将自动被分隔填充。例：你可以从Excel批量复制粘贴数据到此"></i>').tooltip().insertBefore($(els).eq(0));

            }

            var create_product_items_func = function(){

                var spec_v = $('#spec_edit_pane .spec-v');
                /*计算规格交集*/
                var spec_v_item = new Array();
                $.each(spec_v,function(idx,item){
                    if($.trim($(item).val()) == '')return;
                    spec_v_item[idx] = $(item).val().split(',');
                });

                $('#spec_edit_pane .product-items table')[spec_v_item.length?'removeClass':'addClass']('hide');
                if(!spec_v_item.length){
                    return Messagebox.warning('您还没有填写任何规格值。','操作提醒');
                }

                var root_arr = spec_v_item.shift();
                var loop_arr;
                var lnk_arr = function(r,a){
                    var _return = [];
                    $.each(a,function(i,n){
                        _return.push(r+':::'+n);
                    });
                    return _return;
                }

                while(loop_arr = spec_v_item.shift()){
                    var cur_len = root_arr.length;
                    console.log(cur_len);
                    console.log(root_arr);
                    for(var i=0;i<cur_len;i++){
                        var a = root_arr.shift();
                        console.log(a);
                        root_arr = root_arr.concat(lnk_arr(a,loop_arr));
                        console.log(root_arr);

                    }
                    root_arr.slice(cur_len);
                }
                /*计算规格交集*/
                var pit_content = "";
                $.each(root_arr,function(idx,n){
                    pit_content += substitute($('.product-item-tpl').val(),{key:'new_'+idx,spec_info:n.replace(/:::/g,'/'),spec_desc:n});
                });
                $('.product-items tbody').empty().append(pit_content);

                /*支持货号条码换行字符粘贴*/
                listen_postpaste($('.product-items tbody input[name$="[bn]"]'));
                listen_postpaste($('.product-items tbody input[name$="[barcode]"]'));

                var item_length = $('.product-items tbody').find('> tr').length;
                $(this).next('.text-success').remove();
                if(item_length){
                    $(this).after('<span class="text-success">将会新建<span class="badge badge-success">'+item_length+'</span>个货品</span>');
                }

                $.each($('.product-items input[data-map]'),function(i,n){
                    var map = $(n).attr('data-map'),val = $('#no_spec input[data-map="'+map+'"]').val();
                    if(map == 'bn'||map == 'barcode'){
                        if(!val||val==''){
                            val = new String(new Date().getTime()).slice(-5);
                        }
                        val+=map == 'bn'?'-'+i:i;
                    }
                    $(n).val(val);
                });



            };

            var timer_delay = 0;
            $('#spec_edit_pane .create-product-items').on('click',function(e){
                e.stopPropagation();
                clearTimeout(timer_delay);
                var _this = this;
                timer_delay = setTimeout(function(){
                    return create_product_items_func.apply(_this);
                },0);//TODO 性能问题
            });

            var product_items_change = function(){
                if($('#spec_edit_pane .product-items tbody > tr').length){
                    $('#spec_edit_pane .create-product-items').trigger('click');
                }
            };
        }();
        //          
</script>



<script>
$(function() {

    /**
     * 关键词
     */
    $('#goods_keywords_input').tagsInput({
        width: 'auto',
        'defaultText': '输入新词',
    });
})
</script>

<script>
String.prototype.trim = function() {
    return this.replace(/(^\s*)|(\s*$)/g, '');
};


//出厂货号和货号同步
$("#goods_gid").blur(function() {
    var gid = $(this).val();
    $("input[name='goods[product][new_0][bn]']").val(gid);
    //商品名称生成
    generate_goods_name();
});


//提交表单添加商品
$(".save_goods").click(function() {
    var formdata = $("#goods_edit_form").serialize();

    /*$.ajax({
        url: '<{link app=seller ctl=site_goods act=save}>',
        type: 'POST',
        data: formdata,
        dataType: 'json',
        success: function(data) {
            if (data.success) {
                location.href = data.redirect;
            } else {
                alert(data.error);
            }
        }
    });*/
});

</script>


<script>
/**
 *产品图片添加
 */
$(function() {
    var substitute = function(str, obj) {
        return str.replace(/\\?\{([^{}]+)\}/g, function(match, name) {
            if (match.charAt(0) == '\\') return match.slice(1);
            return (obj[name] != undefined) ? obj[name] : '';
        });
    }
    $('input[type="file"]').fileupload({

        add: function(e, data) {
            if (!data.files[0]['type'].match(/^image/)) {
                alert('非法上传，不是图片类型');
                return false;
            }
            data.submit();
        },
        progress:function(e){
            
        },
        done: function(e, data) {

            var re = $.parseJSON(data.result);
            var input = e.target || e.srcElement;
            var content = $('.pro_img_showbox').val();
            $('.filebox').before(substitute(content, re));

            if($('.pro_imgs .pro_img_item').size()==1){
                $('.pro_imgs .pro_img_item').find('.default').addClass('selected');
                var default_val=$('.pro_imgs .pro_img_item:first-child').find('input[type="hidden"]').val();
                $('#images_add').attr('value',default_val);
            }

        }
    });

    //设置默认图片

    $('.pro_imgs').on('click','.item_panel',function(){
        $(this).children('.default').addClass('selected');
        $(this).parents('.pro_img_item').siblings().find('.default').removeClass('selected');

        var default_val=$(this).siblings('.item_con').find('input[type="hidden"]').val();
        $('#images_add').attr('value',default_val);
    })
});
</script>

<script type="text/javascript">
var htmlEditor = {
    'id' : 'summernote',
    'url' : '<{link app=image ctl=site_upload act=wysiswyg_upload}>',
    'name' : ''
}
jQuery.extend(optionHtml, htmlEditor);
$('#summernote').summernote(optionHtml);
</script>

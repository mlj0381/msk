
<div class="modal-body  form-horizontal">
    <div class="form-body">

        <div class="form-group">
            <label class="col-md-2 control-label">商品编号</label>
            <div class="col-md-4">
                <input type="text" disabled="disabled" name="goods[gid]" placeholder="不填写则系统自动生成" class="form-control input-sm" value="<{$goods.gid}>">
                <input type="hidden" name="goods[goods_id]" value="<{$goods.goods_id}>">
            </div>
            <!-- <div class="col-md-4">
            <span class="help-block">此编号用于系统内部管理用</span>
        </div> -->
        </div>
        <div class="form-group">
            <label class="col-md-2 control-label">商品名称
                <span class="required" aria-required="true">*</span>
            </label>
            <div class="col-md-10">
                <input type="text" name="goods[name]" required="true" class="form-control" value="<{$goods.name}>">
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-2 control-label">文字简述 </label>
            <div class="col-md-10">
                <textarea class="form-control" name="goods[brief]" placeholder="简单描述" rows="1">
                    <{$goods.brief}>
                </textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-2 control-label">关键词</label>
            <div class="col-md-10">
                <{foreach from=$goods.keywords item=keywords}>
                    <{assign var='keyword' value="{$keyword},{$keywords.keyword}" }>
                <{/foreach}>
                <input type="text" id="goods_keywords_input" name="keywords" value="<{$keyword|trim:'|'}>" class="form-control" placeholder="多个关键词用,分隔" />
                <span class="help-block hide">多个关键词用","分隔</span>
            </div>
        </div>
        <!--图片-->
        <div class="form-group">
            <label class="col-md-2 control-label">图片
                <input type="hidden" name="image_default" value="<{$goods.image_default_id}>">
            </label>
            <div class="col-md-10">
                <{input type=imagearray}>
            </div>
        </div>

        <div class="form-group">
            <label class="col-md-2  control-label">分类</label>
            <div class="col-md-3">
                <select name="goods[category][cat_id]" class="form-control cat-tree">
                    <option value="0" disabled="false">未分类</option>
                    <{foreach from=$cats item=cat}>
                        <option data-step='<{$cat.step}>' disabled="false" value="<{$cat.cat_id}>" <{if $goods.category.cat_id==$cat.cat_id}>selected
                            <{/if}>>
                                <{$cat.cat_name}>
                        </option>
                        <{/foreach}>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-2  control-label">扩展分类</label>
            <div class="col-md-3">
                <select multiple name="goods[extended_cat][]" class="form-control cat-tree">
                    <{foreach from=$store_cats item=cat}>
                        <option data-step='<{$cat.step}>' value="<{$cat.cat_id}>" <{if $cat.cat_id|in_array:$goods.extended_cat}>selected<{/if}>>
                                <{$cat.cat_name}>
                        </option>
                    <{/foreach}>
                </select>
            </div>
        </div>
        <{if $goods.spec_desc eq ''}>
            <{include file='site/goods/product.html' }>
        <{/if}>


    </div>
</div>
<textarea class="hide gimage-box-process-tpl">
    <div class="tile bg-grey-gallery">
        <div class="tile-body">
            <i class="fa fa-cloud-upload">
            </i>
        </div>
        <div class="tile-object">
            <div class="name">
                <img src="<{$env.STATICS_HOST_URL}>/desktop/admin/layout/img/ajax-modal-loading.gif"/>
            </div>
            <div class="number">
            </div>
        </div>
    </div>
</textarea>
<textarea class="hide gimage-box-done-tpl" style="width:600px;height:200px;">
    <div class="tile image bg-grey">
        <input type="hidden" name="goods[images][]" value="{image_id}">
        <div class="tile-body">
            <img src="{url}" />
        </div>
        <div class="tile-object">
            <div class="number">
                <i class="fa  delete-image" data-image-id="{image_id}"></i>
            </div>
        </div>
    </div>
</textarea>
<style type="text/css">
.fileinput-button input {
    position: absolute;
    top: 0px;
    right: 0px;
    margin: 0px;
    opacity: 0;
    font-size: 200px;
    direction: ltr;
    cursor: pointer;
}
.tile-object {
    background-color: transparent;
    bottom: 0;
    left: 0;
    min-height: 30px;
    position: absolute;
    right: 0;
}
.number {
    bottom: 0;
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.01em;
    line-height: 14px;
    margin-bottom: 8px;
    margin-right: 10px;
    position: absolute;
    right: 0;
    text-align: center;
}
</style>
<script charset="utf-8">
!function(){
    /*商品相册上传选择逻辑*/
    var substitute = function(str,obj){
           return str.replace(/\\?\{([^{}]+)\}/g, function(match, name){
               if (match.charAt(0) == '\\') return match.slice(1);
               return (obj[name] != undefined) ? obj[name] : '';
           });
   }
   var set_default = function(el_box){
       $('.goods-images-pane .selected').removeClass('selected');
       $(el_box).addClass('selected');
       if($('.goods-images-pane .badge-danger').length){
           $(el_box).append($('.goods-images-pane .badge-danger'));
       }else{
           $(el_box).append('<span class="badge badge-roundless badge-danger" style="position:absolute;top:0px;left:0px;">默认图</span>');
       }
       $('input[name="image_default"]').val($(el_box).find('input[name="goods[images][]"]').val());
   }
$('#goods_images_fileupload').fileupload({
    add:function(e,data){
        var file_obj = data.files[0];
        if(!file_obj['type'].match(/^image/)){
            return toastr.warning(data.files[0]['name']+'不是允许的图片类型','类型错误');
        }
        data.context = $($('.gimage-box-process-tpl').val());
        data.context.find('.number')
        .html("<small>"+Math.round(parseFloat(file_obj.size/1024/1024)*100)/100+'MB</small>');
        data.context.insertBefore($('.goods-images-upload-pane'));
        data.submit();
    },
    progress:function(e){
        // (function(){
        //     document.title = (document.title=='正在上传......')?'正在上传...':'正在上传......';
        //     timer = setTimeout(arguments.callee,500);
        // })();
    },
    progressall:function(e){

    },
    done:function(e,data){
        // clearTimeout(timer);
        // document.title = tmp_doc_title;
        try{
            var re = $.parseJSON(data.result);
            data.context.replaceWith(substitute($('.gimage-box-done-tpl').val(),re));
            if(!$('.goods-images-pane .selected').length){
                set_default($('.goods-images-pane .image:first'));
            }
        }catch(e){
            $(data.context).fadeOut(function(){
                $(this).remove();
            });
        }

    }
});
$('.goods-images-pane').on('click','.image',function(e){
        set_default(this);
        return;
});
$('.goods-images-pane').on('click','.delete-image',function(e){
    e.stopPropagation();
    if(!confirm('确认移除？'))return;
    $(this).closest('.image').remove();
    if(!$('.goods-images-pane .selected').length){
        if($('.goods-images-pane .image:first')){
                set_default($('.goods-images-pane .image:first'));
        }else{
                $('input[name="image_default"]').val('');
        }
    }

});
}();


/**
 * 新增粘贴事件
 *
 *    $("input[type='text']").on("postpaste", function() {
 *        // code...
 *    }).pasteEvents();
 *
 *
 */
 $.fn.pasteEvents = function( delay ) {
    if (delay == undefined) delay = 20;
    return $(this).each(function() {
        var $el = $(this);
        $el.on("paste", function() {
            $el.trigger("prepaste");
            setTimeout(function() { $el.trigger("postpaste"); }, delay);
        });
    });
};

</script>

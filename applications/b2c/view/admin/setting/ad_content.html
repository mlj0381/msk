<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">关闭</button>
    <h3 class="modal-title"><{if $ad_id}>编辑<{else}>添加<{/if}>广告</h3>
</div>
<form method="post" action="index.php?app=b2c&ctl=admin_setting&act=ad_content" id='node_edit_form' class="form">
    <input type="hidden" name="id" value="<{$ad_id}>">
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="form-horizontal">
                    <div class="form-body">
                        <div class="table-scrollable col-xs-offset-2">
                            <table class="table  table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th width="13%">图片</th>
                                        <th width="25%">title</th>
                                        <th width="25%">url</th>
                                        <th  width="7%">排序</th>
                                        <th  width="23%">图片上传</th>
                                        <th  width="7%">删除</th>
                                    </tr>
                                </thead>
                                <tbody class="ad-tbody">
                                    <{foreach from=$content.ad_content.title key=key item=item}>
                                    <tr>
                                        <td><img src="<{$content.ad_content.image[$key]|storager:'xs'}>" title="广告图片" alt="广告图片" class="img-thumbnail" style="width:80px; height:80px;"/></td>
                                        <td><input type="text" class="form-control" name="ad_content[title][]" value="<{$content.ad_content.title[$key]}>"/></td>
                                        <td><input type="text" class="form-control" name="ad_content[url][]" value="<{$content.ad_content.url[$key]}>"/></td>
                                        <td><input type="text" class="form-control" name="ad_content[ordernum][]" value="<{$content.ad_content.ordernum[$key]}>"/></td>
                                        <td>
                                            <input type="hidden" name="ad_content[image][]" value="<{$content.ad_content.image[$key]}>"/>
                                            <input type="file" data-url="index.php?app=image&ctl=admin_manage&act=upload" accept="image/*" />
                                        </td>
                                        <td><a href="javascript:;" class="fa fa-trash-o text-danger delete-image"></a></td>
                                    </tr>
                                    <{/foreach}>
                                </tbody>
                            </table>
                        </div>                       
                        <hr>
                        <button type="button" class="btn green add-ad">
                            添加<i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn default" data-dismiss="modal">关闭</button>
        <button type="submit" class="btn blue">保存</button>
    </div>
</form>

<textarea class="hide ad-content">
<tr>
    <td><img src="" title="广告图片" alt="广告图片" class="img-thumbnail" style="width:80px; height:80px;"/></td>
    <td><input type="text" class="form-control" name="ad_content[title][]"/></td>
    <td><input type="text" class="form-control" name="ad_content[url][]"/></td>
    <td><input type="text" class="form-control" name="ad_content[ordernum][]"/></td>
    <td>
        <input type="hidden" name="ad_content[image][]" value=""/>
        <input type="file" data-url="index.php?app=image&ctl=admin_manage&act=upload" accept="image/*" />
    </td>
    <td><a href="javascript:;" class="fa fa-trash-o text-danger delete-image"></a></td>
</tr>
</textarea>

<script>
    $(function (e) {
        var fileObj = {
            add: function (e, data) {
                if (!data.files[0]['type'].match(/^image/)) {
                    alert('非法上传，不是图片类型');
                }
                data.submit();
            },
            done: function (e, data) {
                var re = $.parseJSON(data.result);
                var input = e.target || e.srcElement;
                $(input).prev('input[type="hidden"]').attr('value', re.image_id);
                $(input).closest('tr').find('img').attr('src', re.url);

            }
        };
        $('.add-ad').click(function () {
            var content = $('.ad-content').val();
            var tbody = $('.ad-tbody');
            $(tbody).append(content);
            var firstTr = $(tbody).find('tr:last');
            $(firstTr).find('input[type="file"]').fileupload(fileObj);
        });
        $('.ad-tbody ').on('click', '.text-danger', function () {
            $(this).closest('tr').remove();
        });

        $('.ad-tbody').on('fileupload', 'input[type="file"]', function () {
            func();
        });

        $('input[type="file"]').fileupload(fileObj);
    });
</script>


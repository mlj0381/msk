<h3 class="page-title">
        购物流程设置
</h3>
<form action="index.php?app=b2c&ctl=admin_setting&act=index" method="post" class="form" >
    <div class="form-horizontal">
        <div class="form-body">


            <div class="form-group tiles goods-images-pane">
                <label class="col-md-3 control-label">首页banner</label>
                <div class="col-md-4">
                <{foreach from=$goods.images item=gimage}>
                    <div class="tile image bg-grey <{if $goods.image_default_id==$gimage.image_id}>selected<{/if}>">
                        <input type="hidden" name="banner_images[]" value="<{$gimage.image_id}>">
                        <div class="tile-body">
                            <img src="<{$gimage.image_id|storager:'s'}>" />
                        </div>
                        <div class="tile-object">
                            <div class="number">
                                <i class="fa fa-trash-o text-danger delete-image" data-image-id="<{$gimage.image_id}>"></i>
                            </div>
                        </div>
                        <{if $goods.image_default_id==$gimage.image_id}>
                        <span class="badge badge-roundless badge-danger" style="position:absolute;top:0px;left:0px;">默认图</span>
                        <{/if}>
                    </div>
                <{/foreach}>
                <div class="tile bg-grey goods-images-upload-pane fileinput-button">
                    <div class="tile-body">
                        <i class="glyphicon glyphicon-plus"></i>
                    </div>
                    <input id="goods_images_fileupload" type="file"  multiple data-url="index.php?app=image&ctl=admin_manage&act=gimages_upload" accept="image/*">
                </div>
            </div>
        </div>


            <{foreach from=$setting item=item key=key}>
                <div class="form-group">
                    <label class="col-md-3 control-label"><{$item.desc}></label>
                    <div class="col-md-4">
                        <{if $item.required}>
                        <{input required=true type=$item.type name=$key value=$item.value|default:$item.default options=$item.options }>
                        <{else}>
                        <{input type=$item.type name=$key value=$item.value|default:$item.default options=$item.options }>
                        <{/if}>
                        <{if $item.helpinfo}>
                            <span class="help-block"><{$item.helpinfo}></span>
                        <{/if}>
                    </div>
                </div>
            <{/foreach}>
            <div class="form-actions">
                <div class="row">
                    <div class="col-md-offset-3 col-md-9">
                        <button type="submit" class="btn blue">保存</button>
                        <a href="<{link app=desktop ctl=adminpanel}>" class="btn default">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<textarea class="hide gimage-box-process-tpl">
    <div class="tile bg-grey-gallery">
        <div class="tile-body">
            <i class="fa fa-cloud-upload">
            </i>
        </div>
        <div class="tile-object">
            <div class="name">
                <img src="<{$env.STATICS_HOST_URL}>/desktop/admin/layout/img/ajax-modal-loading.gif"/>
            </div>
            <div class="number">
            </div>
        </div>
    </div>
</textarea>
<textarea class="hide gimage-box-done-tpl">
    <div class="tile image bg-grey">
        <input type="hidden" name="banner_images[]" value="{image_id}">
        <div class="tile-body">
            <img src="{url}" />
        </div>
        <div class="tile-object">
            <div class="number">
                <i class="fa fa-trash-o delete-image" data-image-id="{image_id}"></i>
            </div>
        </div>
    </div>
</textarea>
<script>
!function(){
    /*商品相册上传选择逻辑*/
    var substitute = function(str,obj){
           return str.replace(/\\?\{([^{}]+)\}/g, function(match, name){
               if (match.charAt(0) == '\\') return match.slice(1);
               return (obj[name] != undefined) ? obj[name] : '';
           });
   }
   /*相册拖动排序*/
   $('.goods-images-pane').sortable({
       cursor: "move",
       items:'> .image'
   });

    var set_default = function(el_box){
        $('.goods-images-pane .selected').removeClass('selected');
        $(el_box).addClass('selected');
        if($('.goods-images-pane .badge-danger').length){
            $(el_box).append($('.goods-images-pane .badge-danger'));
        }else{
            $(el_box).append('<span class="badge badge-roundless badge-danger" style="position:absolute;top:0px;left:0px;">默认图</span>');
        }
        $('input[name="image_default"]').val($(el_box).find('input[name="goods[images][]"]').val());
    }
    //var tmp_doc_title = document.title,timer = 0;
    $('#goods_images_fileupload').fileupload({
        add:function(e,data){
            var file_obj = data.files[0];
            if(!file_obj['type'].match(/^image/)){
                return toastr.warning(data.files[0]['name']+'不是允许的图片类型','类型错误');
            }
            data.context = $($('.gimage-box-process-tpl').val());
            data.context.find('.number')
            .html("<small>"+Math.round(parseFloat(file_obj.size/1024/1024)*100)/100+'MB</small>');
            data.context.insertBefore($('.goods-images-upload-pane'));
            data.submit();
        },
        progress:function(e){
            // (function(){
            //     document.title = (document.title=='正在上传......')?'正在上传...':'正在上传......';
            //     timer = setTimeout(arguments.callee,500);
            // })();
        },
        progressall:function(e){

        },
        done:function(e,data){
            // clearTimeout(timer);
            // document.title = tmp_doc_title;
            try{
                var re = $.parseJSON(data.result);
                data.context.replaceWith(substitute($('.gimage-box-done-tpl').val(),re));
                if(!$('.goods-images-pane .selected').length){
                    set_default($('.goods-images-pane .image:first'));
                }
            }catch(e){
                $(data.context).fadeOut(function(){
                    $(this).remove();
                });
            }

        }
    });

    $('.goods-images-pane').on('click','.image',function(e){
            set_default(this);
            return;
    });
    $('.goods-images-pane').on('click','.delete-image',function(e){
        e.stopPropagation();
        if(!confirm('确认移除？'))return;
        $(this).closest('.image').remove();
        if(!$('.goods-images-pane .selected').length){
            if($('.goods-images-pane .image:first')){
                    set_default($('.goods-images-pane .image:first'));
            }else{
                    $('input[name="image_default"]').val('');
            }
        }

    });

    /*分类树逻辑*/
    $.each($('.cat-tree option'),function(i,n){
        var step = $(n).attr('data-step');
        while(step>1){
            $(n).html('&nbsp&nbsp&nbsp&nbsp'+$(n).html());
            step--;
        }
    });
}();

</script>
